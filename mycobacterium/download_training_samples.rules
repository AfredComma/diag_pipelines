from snakemake.utils import report
import re
import os
import pandas

shell.prefix("set -euo pipefail;") 

include: "../assembly/assembly.rules"
configfile: "config.yaml"

samples = pandas.read_csv(config["samples"], index_col=0)

rule get_sra:
    conda:
        "env/sra-tools.yaml"
    output:
        temp("reads/raw/{sample}_R1_001.fastq"),
        temp("reads/raw/{sample}_R2_001.fastq")
    params:
        sra = lambda wildcards: samples.loc[wildcards.sample, "Sequence_Read_Archive"] if len(samples.loc[wildcards.sample, "Sequence_Read_Archive"].split(","))==1 else samples.loc[wildcards.sample, "Sequence_Read_Archive"].split(",")[0]
    shell:
        """
        fastq-dump --split-files --outdir reads/raw/ {params.sra}
        mv reads/raw/{params.sra}_1.fastq reads/raw/{wildcards.sample}_R1_001.fastq 
        mv reads/raw/{params.sra}_2.fastq reads/raw/{wildcards.sample}_R2_001.fastq 
        """

rule report:
    input:
        rgis=expand("logs/{sample}/rgi_mysql.txt", sample=list(samples.index.values)),
        locals=expand("logs/{sample}/local_mysql.txt", sample=list(samples.index.values))
    output:
        "report.html"
    run:
        report("""
        Report of the comparative genomics pipeline 
        """, output[0])
