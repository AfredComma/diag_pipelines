rule download_data_from_niaid:
    output:
        "cases.html",
        "patient_data.txt",
        "logs/download_niaid.txt"
    shell:
        """
        wget -qO- https://data.tbportals.niaid.nih.gov/cases?dstProfile=sensitive%2CMDRnonXDR%2CpolyDR%2CmonoDR%2CXDR\&sequenced=True\&_take=10000 > {output[0]}
        grep "href='/patient/.*case/details/.*" {output[0]} | sed "s/.*'\//https:\/\/data.tbportals.niaid.nih.gov\//" | sed "s/'//g" > {output[1]}
        wget -N -i patient_data.txt -P patient_html/ -o {output[2]}
        """

rule parse_and_load_html_files_from_niaid:
    conda:
        "env/biopython-mysql.yaml"
    input:
        "logs/download_niaid.txt",
        ancient("/home/sacha/.my.cnf"),
        "patient_data.txt"
    params:
        folder="patient_html/"
    output:
        "logs/parsing_niaid.txt"
    script:
        "scripts/parse_html.py"

rule create_dbs:
    conda:
        "env/biopython-mysql.yaml"
    input:
        ancient("/home/sacha/.my.cnf")
    output:
        "logs/db_mysql.txt"
    script:
        "scripts/create_db.py"


