rule check_annotated_mutations_from_database_and_create_bed_file:
    conda:
        pipeline_path + "envs/pandas-openpyxl-pronto-xlrd.yaml"
    input:
        db = pipeline_path + "data/" + species + "/mutations/{db}.tsv",
        gene_to_locus = pipeline_path + "data/" + species + "/metadata/locus_tags.tsv",
        gbk = "references/" + reference_assembly_for_resistance[species] + "/genome_gbwithparts.gbk",
    output:
        bed_correct = "resistance/annotations/{db}/correct.bed",
        incorrect_annotation = "resistance/annotations/{db}/incorrect.tsv",
    script:
        "scripts/check_locus_against_database.py"

rule annotate_positions_from_genotyping:
    conda:
        pipeline_path + "envs/bcftools.yaml"
    input:
        bed_correct = "resistance/annotations/{db}/correct.bed",
        bed_gz_correct = "resistance/annotations/{db}/correct.bed.gz",
        bed_tbi_correct = "resistance/annotations/{db}/correct.bed.gz.tbi",
        genotype = "samples/{sample}/snps/gatk/" + reference_assembly_for_resistance[species] + "/bwa/snps.g.vcf.gz",
        genotype_tbi = "samples/{sample}/snps/gatk/" + reference_assembly_for_resistance[species] + "/bwa/snps.g.vcf.gz.tbi",
    output:
        annotation = "samples/{sample}/resistance/{db}/annotation.vcf",
        header = temp("samples/{sample}/resistance/{db}/header.txt"),
    shell:
        """
        echo '##INFO=<ID=GENE,Number=1,Type=String,Description="Gene">' >> {output[header]}
        echo '##INFO=<ID=STRAND,Number=1,Type=Integer,Description="Strand">' >> {output[header]}
        echo '##INFO=<ID=POSITION_IN_GENE,Number=1,Type=Integer,Description="Position with respect to Gene">' >> {output[header]}
        echo '##INFO=<ID=WILDTYPE_AA_NUCL,Number=1,Type=String,Description="Wildtype amino acid or nucleotide">' >> {output[header]}
        echo '##INFO=<ID=WILDTYPE_CODON_NUCL,Number=1,Type=String,Description="Wildtype codon or nucleotide">' >> {output[header]}
        bcftools view --regions-file {input[bed_correct]} {input[genotype]} | bcftools annotate --annotation {input[bed_gz_correct]} --columns CHROM,FROM,TO,INFO/GENE,INFO/STRAND,INFO/POSITION_IN_GENE,INFO/WILDTYPE_AA_NUCL,INFO/WILDTYPE_CODON_NUCL --header-lines {output[header]} - > {output[annotation]}
        """

rule extract_mutated_codons_or_nucleotides:
    conda:
        pipeline_path + "envs/bcftools.yaml"
    input:
        annotation = "samples/{sample}/resistance/{db}/annotation.vcf",
    output:
        genotype = "samples/{sample}/resistance/{db}/position_genotypes.txt",
    shell:
        """
        bcftools view --include 'GT="alt"' {input[annotation]} | bcftools query --format "%CHROM\\t%POS\\t[%INFO/GENE]\\t[%INFO/POSITION_IN_GENE]\\t[%INFO/STRAND]\\n" | while read chrom pos gene position strand
        do
            gt=$(bcftools view --include "INFO/GENE='${{gene}}' && INFO/POSITION_IN_GENE=${{position}}" {input[annotation]} | bcftools query --format "[%TGT]")
            echo ${{chrom}} ${{pos}} ${{gt}} ${{strand}} >> {output[genotype]}
        done
        """
        
rule convert_mutated_codons_or_nucleotides_to_aa_or_nucleotides:
    conda:
        pipeline_path + "envs/pandas-openpyxl-pronto-xlrd.yaml"
    input:
        genotype = "samples/{sample}/resistance/{db}/position_genotypes.txt",
    output:
        mutation = "samples/{sample}/resistance/{db}/mutations.bed",
    script:
        "scripts/convert_position_to_mutation.py"
        

rule add_mutated_amino_acid_or_nucleotide_value_to_annotation_and_exclude_synonymous_mutations:
    conda:
        pipeline_path + "envs/bcftools.yaml"
    input:
        mutation_gz = "samples/{sample}/resistance/{db}/mutations.bed.gz",
        mutation_tbi = "samples/{sample}/resistance/{db}/mutations.bed.gz.tbi",
        annotation = "samples/{sample}/resistance/{db}/annotation.vcf",
    output:
        header = "samples/{sample}/resistance/{db}/header_mutations.txt",
        mutation = "samples/{sample}/resistance/{db}/mutations.vcf",
    shell:
        """
        echo '##INFO=<ID=MUTATED_AA_NUCL,Number=1,Type=String,Description="Mutation in the context of the gene (can be amino acid or nucleotide)">' > {output[header]}
        echo '##INFO=<ID=MUTATED_CODON_NUCL,Number=1,Type=String,Description="Mutation in the context of the gene (can be codon or nucleotide)">' >> {output[header]}
        bcftools annotate --include 'GT="alt"' --annotation {input[mutation_gz]} --columns CHROM,FROM,TO,INFO/MUTATED_AA_NUCL,INFO/MUTATED_CODON_NUCL --header-lines {output[header]} {input[annotation]} | bcftools view --exclude 'INFO/WILDTYPE_AA_NUCL=INFO/MUTATED_AA_NUCL' > {output[mutation]}
        """
