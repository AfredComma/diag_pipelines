rule calculate_core_genome_parsnp:
    input:
        "bin/parsnp",
        "references/all_genomes_log.txt",
    output:
        "core/parsnp.xmfa"
    shell:
        """
        bin/parsnp -r ! -d $(dirname {input[1]})/all_complete_genomes/ -c -o $(dirname {output[0]})
        """

rule extract_core_genome_from_ref:
    conda:
        "env/bedtools.yaml"
    input:
        "core/parsnp.xmfa",
        "references/{ref}/genome.gbk"
    output:
        "core/{ref}_core.bed",
        "core/{ref}_core_sorted.bed"
    shell:
        """
        accession=$(grep "ACCESSION" {input[1]} | sed "s/ACCESSION *//" | cut -f1 -d' ' | tr -d '[:space:]')
        id=$(grep -B 2 $accession {input[0]} | head -n 1 | cut -f2 -d' ')
        grep ">${{id}}:[0-9]\+-[0-9]\+" {input[0]} | sed "s/ .*//" | sed "s/-/\t/" | sed "s/:/\t/" | sed "s/^>${{id}}/${{accession}}/" > {output[0]}
        bedtools sort -i {output[0]} > {output[1]}

        """
        
