rule get_reference_or_representative_or_complete_genome:
    conda:
        "env/entrez-direct.yaml"
    output:
        "references/{ref}_url.txt"
    shell:
        """
        search=$( echo {wildcards.ref} | tr '_' ' ')
        esearch -db assembly -query "${{search}}" | efetch -db assembly -format docsum | xtract -pattern DocumentSummary -unless LatestAccession -if RefSeq_category -equals "reference genome" -element FtpPath_RefSeq | sed  "s/\(\/GCF_.*\)/\\1\\1_genomic.gbff.gz/" > {output[0]}
        if [  ! -s {output[0]} ]; then 
             esearch -db assembly -query "${{search}}" | efetch -db assembly -format docsum | xtract -pattern DocumentSummary -unless LatestAccession -if RefSeq_category -equals "representative genome" -element FtpPath_RefSeq | sed  "s/\(\/GCF_.*\)/\\1\\1_genomic.gbff.gz/" > {output[0]}
        if [ ! -s {output[0]} ]; then
             esearch -db assembly -query "${{search}}" | efetch -db assembly -format docsum | xtract -pattern DocumentSummary -unless LatestAccession -if AssemblyStatus -equals "Complete Genome" -element FtpPath_RefSeq | sed  "s/\(\/GCF_.*\)/\\1\\1_genomic.gbff.gz/" > {output[0]}
        fi
        fi
        """

rule download_genomes_from_url:
    input:
        "references/{ref}_url.txt"
    output:
        "references/{ref}/genome.gbk"
    shell:
        """
        head -n 1 {input[0]} | xargs wget -qO- | gzip -d > {output[0]}
        """
        
