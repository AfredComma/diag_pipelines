rule snippy_to_gbk_paired:
    conda:
        "env/snippy.yaml"
    input:
        ancient("reads/raw/{sample}_R1.fastq.gz"),
        ancient("reads/raw/{sample}_R2.fastq.gz"),
        ancient("references/{ref}/genome.gbk")
    output:
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.vcf",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.vcf.gz",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.bam",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.bam.bai",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.vcf.gz.tbi",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/reference/ref.fa",
        
    log:
        "strains/{sample}/mapping/snippy.log"
    shell:
        """
        snippy --cpus 1 --force --outdir $(dirname {output[0]}) --reference {input[2]} --R1 {input[0]} --R2 {input[1]} 2> {log}
        tabix -f -p vcf {output[1]}
        """
        
rule snippy_to_gbk_single:
    conda:
        "env/snippy.yaml"
    input:
        "reads/raw/{sample}_single.fastq",
        "references/{ref}/genome.gbk"
    output:
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.vcf",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.vcf.gz",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.bam",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.bam.bai",
        "strains/{sample}/mapping/snippy/{ref}/before_validation/{sample}/snps.vcf.gz.tbi"
    log:
        "mapping/snippy/{ref}/{sample}/snps.log"
    shell:
        """
        snippy --cpus 1 --force --outdir $(dirname {output[0]}) --reference {input[1]} --se {input[0]} 2> {log}
        tabix -f -p vcf {output[1]}
        """

rule snippy_core:
    conda:
        "env/snippy-bcftools.yaml"
    input:
        ancient(expand("strains/{sample}/mapping/snippy/{{ref}}/{sample}/snps.vcf", sample=list(read_naming.keys())))
    output:
        "typing/core_snippy/{ref}/before_validation/core.aln",
        "typing/core_snippy/{ref}/before_validation/core.vcf",
        "typing/core_snippy/{ref}/before_validation/merged.vcf",
        "typing/core_snippy/{ref}/before_validation/core.vcf.gz",
        "typing/core_snippy/{ref}/before_validation/core.vcf.gz.tbi"
    shell:
        """
        snippy-core --prefix $(dirname {output[0]})/core $(dirname {input})
        bgzip -c {output[1]} > {output[3]}
        tabix -f -p vcf {output[3]}
        bcftools view --samples ^Reference {output[3]} > {output[2]}
        """
        
