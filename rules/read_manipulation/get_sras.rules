

sra_download_dir = subprocess.Popen('''vdb-config --cfg -o n | grep "/repository/user/main/public/root" | cut -f2 -d'=' | sed "s/\\"//g"''', shell=True, stdout=subprocess.PIPE).stdout.read().rstrip().decode('UTF-8').replace(' ','')

rule download_sra:
    conda:
        pipeline_path + "envs/sra-tools.yml"
    output:
        temp("%s/sra/{sample}.sra" % sra_download_dir),
    log:
        logging_folder + "samples/{sample}/sras/dump.txt"
    shell:
        """
        vdb-config --restore-defaults
        cache_dir=$(vdb-config --cfg -o n | grep "/repository/user/main/public/root" | cut -f2 -d'=' | sed "s/\\"//g")
        prefetch -v {wildcards.sample} --max-size 100000000 &> {log}
        """

rule sra_convert_to_fastq_paired:
    conda:
        "envs/sra-tools.yml"
    input:
        "%s/sra/{sample}.sra" % sra_download_dir,
    output:
        temp(link_directory + "{sample,[A-Za-z0-9]+}_1.fastq.gz"),
        temp(link_directory + "{sample,[A-Za-z0-9]+}_2.fastq.gz"),
    log:
        "log/sra_download/{sample}_dump.txt"
    params:
        sra_dir = sra_download_dir
    shell:
        """
        vdb-config --restore-defaults
        cache_dir=$(vdb-config --cfg -o n | grep "/repository/user/main/public/root" | cut -f2 -d'=' | sed "s/\\"//g")
        fastq-dump --split-3 --gzip --log-level 1 --disable-multithreading --minReadLen 0 --outdir $(dirname {output[0]}) {input[0]}
        """
