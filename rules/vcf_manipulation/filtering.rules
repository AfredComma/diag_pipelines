rule normalize_and_vt_decompose_from_freebayes:
    conda:
        "../../envs/vt-bcftools.yaml"
    input:
        "typing/{snp_caller}/full_genome/{ref}/{mapping_method}/raw/all_samples.vcf.gz",
        "typing/{snp_caller}/full_genome/{ref}/{mapping_method}/raw/all_samples.vcf.gz.tbi",
        ref=ancient("references/{ref}/genome_fasta.fasta"),
    output:
        normalized="typing/{snp_caller}/full_genome/{ref}/{mapping_method}/all_samples.vcf"
    log:
        logging_folder+"/typing/{snp_caller}/full_genome/{ref}/{mapping_method}/vt_normalize.txt"
    shell:
        """
        bcftools norm -f {input[ref]} -m -any {input[0]} | vt decompose_blocksub - | bcftools norm -m +any > {output[normalized]}
        """
