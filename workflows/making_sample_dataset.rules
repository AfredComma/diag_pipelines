import sys
import pandas

sys.path.insert(0, config["absolute_path_of_pipeline_folder"])

import helper_scripts.get_sample_naming_from_link_folder as sample_naming

from helper_scripts.get_folder_and_subfolders import get_folders_structure_with_sample_naming

link_directory="links/"

reads_local, folders, original_name = get_folders_structure_with_sample_naming(link_directory, sample_naming.get_read_naming_patterns)


samples_data = pandas.read_csv(config["sample_names"], sep="\t", index_col=0)
samples_data.index = [str(x) for x in samples_data.index]
all_samples= "".join(list(samples_data.index))
if "(" in all_samples or ")" in all_samples or "_-_" in all_samples:
    raise ValueError("Forbidden character in sample name in sample name file") 
read_correct = {}
original_correct = {}
folders_correct = {}
if folders.keys():
    for i in folders.keys():
        match = [ i.startswith(str(x)) for x in list(samples_data.index)]
        if sum(match) > 1:
            raise ValueError("Problem matching SampleNames to read file names")
        sample=str(samples_data.index[match.index(True)])
        folders_correct[sample] = folders[i]
        original_correct[sample] = original_name[i]
        read_correct[sample] = reads_local[i]
original_name = original_correct
reads_local = read_correct
folders = folders_correct
    
sras_ext = {}
sras_folder = {}
reads_sra = {}

if "sra_samples" in config.keys() and config["sra_samples"]:
    reads_sra_pandas = pandas.read_csv(config["sra_samples"], sep="\t", index_col=0)
    all_samples= "".join(list(reads_sra_pandas["SampleName"]))
    if "(" in all_samples or ")" in all_samples or "_-_" in all_samples:
        raise ValueError("Forbidden character in sample name in sra file") 
    for i in reads_sra_pandas.index:
        sample_name=reads_sra_pandas.loc[i, "SampleName"]
        if sample_name in reads_sra.keys():
            sample_name=sample_name+"_"+str(list(reads_sra.keys()).count(sample_name))
        reads_sra[sample_name]=str(i)
        sras_folder[sample_name]="."
        if reads_sra_pandas.loc[i, "LibraryLayout"].lower()=="paired":
            sras_ext[sample_name]=["1.fastq.gz", "2.fastq.gz"]
        elif reads_sra_pandas.loc[i, "LibraryLayout"].lower()=="single":
            sras_ext[sample_name]=["single.fastq.gz"]
        else:
            raise ValueError("Problem in the sra file")
        samples_data.loc[sample_name, "ScientificName"]=reads_sra_pandas.loc[i, "ScientificName"]
                        


read_naming = { **reads_local, **sras_ext}
original_name = { **original_name, **reads_sra}
folders = { **folders, **sras_folder}

