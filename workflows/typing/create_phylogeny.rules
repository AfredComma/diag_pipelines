import csv
import os.path

def get_read_naming_patterns(directory):
    result = []
    extension= {}
    for fname in os.listdir(directory):
        if fname.endswith("fastq.gz") or fname.endswith("fq.gz") or fname.endswith("fastq") or fname.endswith("fq"):
            ext = re.search(r'_R(1|2)(\.|_).*', fname)
            if ext is None:
                ext = re.search(r'f(?:ast)?q(?:\.gz)?', fname)
                samp = re.sub("\.$", "", re.search(r'^([^\.]*)\.*', fname).group(0))
                if samp in extension.keys():
                    if ext.group(0).endswith(".gz"):
                        extension[samp]=[ext.group(0)]
                else:
                    extension[samp]=[ext.group(0)]
            else:
                read = re.compile(re.search(r'_R(1|2)(\.|_)', fname).group(0).replace("_", "").replace(".", ""))
                samp = re.sub(r'_R(1|2)$', '', re.search(r'.*_R(1|2)', fname).group(0))
                extension.setdefault(samp, [])
                match = list(filter(read.match, extension[samp]))
                if len(match) == 1:
                    if match[0].endswith("fastq") or match[0].endswith("fq"):
                        extension[samp].remove(match[0])
                        extension[samp].append(re.sub("^_", "", ext.group(0)))
                else:
                    extension[samp].append(re.sub("^_", "", ext.group(0)))
    return(extension)


def get_sample_names_correspondance(filename):
    corres = {}
    with open(filename) as csvfile:
        reader = csv.reader(csvfile, delimiter='\t', quotechar='|')
        for row in [[s.strip() for s in inner] for inner in reader]:
            cells = list(filter(None, row))
            corres[cells[0]] = cells[1].replace(" ", "_")
    return(corres)
        
read_naming = get_read_naming_patterns("links/")

if os.path.isfile("sample_names.tsv"):
    sample_correspondance = get_sample_names_correspondance("sample_names.tsv")


prefix = "../../rules/"

include:
    prefix + "read_manipulation/get_reads.rules"

include:
    prefix + "downloading/fetch_references.rules"

include:
    prefix + "mapping/snippy.rules"

include:
    prefix + "phylogeny/raxml.rules"

include:
    prefix + "assembly/assembly.rules"

include:
    prefix + "typing/mlst.rules"

include:
    prefix + "typing/snps_distance.rules"


rule all:
    input:
        "phylogeny/{ref}.svg",
        "typing/mlst/summary.out"
    output:
        "report_{ref}.html"
    shell:
        """
        echo "" > {output[0]}
        """
    
